type: sections
max_columns: 4
title: Kidname Aufgaben
path: Kidname
sections:
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                points=0, points_label='', points_icon='', overdue=0,
                weekly_completed=0, todays_completed=0, all_time_completed='',
                all_badges=[], badge_list=[], badge_name_normalize='',
                badges_sensor='', highest_badge='', highest_badge_icon='',
                highest_badge_normalize='', highest_badge_entity='',
                highest_badge_multiplier='', highest_badge_display_line='',
                achievements=[], challenges=[], content='',

                  WELCOME='', 
                  ACHIEVEMENTS='', CHALLENGES='', NONE='',
                  WEEKLY_COMPLETED='', TODAYS_COMPLETED=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.WELCOME = "Willkommen" -%} 

                {%- set ns.NONE = "Keine" -%}

                {%- set ns.WEEKLY_COMPLETED = "Wöchentlich abgeschlossen" -%}

                {%- set ns.TODAYS_COMPLETED = "Heute abgeschlossen" -%}

                {%- set ns.ACHIEVEMENTS = "Erfolge" -%}

                {%- set ns.CHALLENGES = "Herausforderungen" -%}  

                {#-- ************* End Translatable Text ************* --#}


                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Collect Points -- #}  {%- set points_sensor = 'sensor.kc_'
                ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set ns.points =
                states(points_sensor) | int(default=0) -%} {%- set
                ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%} {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Overdue Chores -- #}  {%- set
                chore_sensor_id_prefix = 'sensor.kc_'~ ns.Kid_name_normalize ~
                '_chore_status_' -%}   {%- set ns.overdue = states.sensor 
                    | selectattr('entity_id', 'match', '^' ~ chore_sensor_id_prefix ~ '.*') 
                    | selectattr('state', 'eq', 'overdue') 
                    | list | length | int(default=0) -%}

                {# -- Collect Weekly Completed -- #}  {%- set weekly_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_chores_completed_weekly' -%}  {%- set ns.weekly_completed =
                states(weekly_sensor) | int(default=0) -%}

                {# -- Collect Today's Completed -- #}  {%- set todays_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_chores_completed_daily'
                -%}  {%- set ns.todays_completed = states(todays_sensor) |
                int(default=0) -%}

                {# -- Collect Total Completed -- #}  {%- set all_time_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_chores_completed_total'
                -%}  {%- set ns.all_time_completed = states(all_time_sensor) |
                int(default=0) -%}

                {# -- Get Highest Badge Earned -- #}   

                {%- set highest_badge_sensor = 'sensor.kc_' ~
                ns.Kid_name_normalize ~ '_highest_badge' -%}    {%- set
                ns.highest_badge = states(highest_badge_sensor) or 'None' -%}  
                {%- set ns.highest_badge_icon = state_attr(highest_badge_sensor,
                'icon') or 'mdi:medal-outline' -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.highest_badge_normalize = ns.highest_badge -%}  {%-
                for letter, replacement in replacements.items() -%}
                  {%- set ns.highest_badge_normalize = ns.highest_badge_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.highest_badge_normalize = ns.highest_badge_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Get Multiplier for Highest Badge -- #}

                {%- set ns.highest_badge_entity = 'sensor.kc_' ~
                ns.highest_badge_normalize ~ '_badge' -%} {%- set
                ns.highest_badge_multiplier =
                state_attr(ns.highest_badge_entity, 'points_multiplier') |
                float(default=1) -%}

                {# -- Construct Badge Display Line for Markdown -- #}

                {%- if ns.highest_badge not in ['None', 'unknown', 'Unknown']
                -%}
                  {%- if ns.highest_badge_multiplier > 1 -%}
                    {%- set ns.badge_display_line = "<ha-icon icon='" ~ ns.highest_badge_icon ~ "'></ha-icon> " ~ ns.highest_badge ~ " (x" ~ ns.highest_badge_multiplier|string ~ ")  \n" 
                    -%}
                  {%- else -%}
                    {%- set ns.badge_display_line = "<ha-icon icon='" ~ ns.highest_badge_icon ~ "'></ha-icon> " ~ ns.highest_badge ~ "  \n" 
                    -%}
                  {%- endif -%}
                {%- else -%}
                  {%- set ns.badge_display_line = "" -%}
                {%- endif -%}


                {# -- Get All Earned Badges -- #}  

                {%- set ns.all_badges = state_attr(highest_badge_sensor, 'all_earned_badges') | default([], true) -%}

                {# -- Construct the Badge List with Icons -- #}

                {%- set ns.badge_list = "\n " -%} {%- for badge in ns.all_badges
                -%}

                      {# -- Replace Accented Letters -- #}

                      {%- set ns.badge_name_normalize = badge -%}  {%- for
                      letter, replacement in replacements.items() -%}
                        {%- set ns.badge_name_normalize = ns.badge_name_normalize | replace(letter, replacement) -%}
                      {%- endfor -%}

                      {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                      {%- set ns.badge_name_normalize = ns.badge_name_normalize
                          | regex_replace("[^a-zA-Z0-9]", "_")
                          | regex_replace("_+", "_")
                          | regex_replace("^_", "")
                          | regex_replace("_$", "")
                          | lower
                      -%}

                  {%- set badge_sensor = 'sensor.kc_' ~ ns.badge_name_normalize ~ '_badge' -%}
                  {%- set badge_icon = state_attr(badge_sensor, 'icon') | default('mdi:medal-outline') -%}
                  {%- set ns.badge_list = ns.badge_list + "- <ha-icon icon='" ~ badge_icon ~ "'></ha-icon> " ~ badge ~ "  \n" -%}
                {%- endfor -%}



                {# -- Collect Achievements with Progress and Rewards -- #} {%-
                set achievement_prefix = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_achievement_status_' -%}   {%- set achievement_list =
                states.sensor | selectattr('entity_id', 'match',
                achievement_prefix ~ '.*') | list -%}   {%- for sensor in
                achievement_list -%}
                  {%- set name = state_attr(sensor.entity_id, 'achievement_name') | default('Unknown Achievement') -%}
                  {%- set icon = state_attr(sensor.entity_id, 'icon') or 'mdi:trophy-award' -%}
                  {%- set progress = states(sensor.entity_id) | float(default=0) -%}
                  {%- set award_status = state_attr(sensor.entity_id, 'awarded') -%}

                  {# -- Get Overall Sensor for Reward Points -- #}
                  {%- set overall_sensor = sensor.entity_id | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}

                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = ns.COMPLETED if award_status == 'true' else '⌛ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.achievements = ns.achievements + ["&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", 💎 " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {# -- Collect Challenges with Progress and Rewards -- #} {%- set
                challenge_prefix = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_challenge_status_' -%}   {%- set challenge_list =
                states.sensor | selectattr('entity_id', 'match',
                challenge_prefix ~ '.*') | list -%}   {%- for sensor in
                challenge_list -%}
                  {%- set name = state_attr(sensor.entity_id, 'challenge_name') | default('Unknown Challenge') -%}
                  {%- set icon = state_attr(sensor.entity_id, 'icon') or 'mdi:flag-checkered' -%}
                  {%- set progress = states(sensor.entity_id) | float(default=0) -%}
                  {%- set award_status = state_attr(sensor.entity_id, 'awarded') -%}

                  {# -- Get Overall Sensor for Reward Points -- #}
                  {%- set overall_sensor = sensor.entity_id | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}
                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = ns.COMPLETED if award_status == 'true' else '⌛ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.challenges = ns.challenges + ["&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", 💎 " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {#-- Create Content Variable --#}  

                {%- set ns.content = 
                  "## 👋 " ~ ns.WELCOME ~ ", " ~ ns.Kid_name ~ "! \n"
                  "#### " ~ "<ha-icon icon=" ~ ns.points_icon ~ "></ha-icon>" ~ "&nbsp;&nbsp;" ~ ns.points_label ~ ": &nbsp;&nbsp;" ~ ns.points ~ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" ~ ns.badge_display_line ~ " \n"
                  "**📅 " ~ ns.WEEKLY_COMPLETED ~ ":** &nbsp;&nbsp;" ~ ns.weekly_completed ~ "  \n"
                  "**☀️ " ~ ns.TODAYS_COMPLETED ~ ":** &nbsp;&nbsp;" ~ ns.todays_completed ~ "  \n\n"
                  "**🏆 " ~ ns.ACHIEVEMENTS ~ ":** &nbsp;&nbsp; " ~ 
                  ('\n' ~ ('\n'.join(ns.achievements)) if ns.achievements | length > 0 else "&nbsp;" ~ ns.NONE) ~ "  \n"
                  "**🏁 " ~ ns.CHALLENGES ~ ":** &nbsp;&nbsp; " ~ 
                  ('\n' ~ ('\n'.join(ns.challenges)) if ns.challenges | length > 0 else "&nbsp;" ~ ns.NONE) ~ "  \n"
                -%}

                {{
                  {
                    'type': 'markdown',
                    'content': ns.content
                  }
                }},
      - type: grid
        square: false
        columns: 1
        cards:
          - type: heading
            icon: mdi:broom
            heading: Aufgaben
            heading_style: title
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 2
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', 
                  Kid_name_normalize='',
                  pref_exclude_approved='', 
                  overdue_buttons=[], 
                  am_buttons=[],
                  pm_buttons=[],
                  other_buttons=[],
                  complete_buttons=[],
                  heading_card_blank='',
                  points_label='', 
                  points_icon='',


                  OVERDUE='', THIS_MORNING='', TODAY='', BONUS='', 
                  STREAK='', STATUS='', DUE=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.OVERDUE = "!!!!!!!!!!! Überfällig !!!!!!!!!!!" -%} 

                {%- set ns.THIS_MORNING = "Fällig heute Morgen" -%} 

                {%- set ns.TODAY = "Fällig heute" -%}

                {%- set ns.BONUS = "Bevorstehend & Bonus" -%} 

                {%- set ns.STREAK = "Serie" -%}

                {%- set ns.STATUS = "Status" -%}

                {%- set ns.DUE = "Fällig" -%}  

                {#-- ************* End Translatable Text ************* --#}


                {#-- Set preferences --#} 

                {%- set ns.pref_exclude_approved = false -%}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Point Labels -- #}    {%- set points_sensor = 'sensor.kc_'
                ~ ns.Kid_name_normalize ~ '_points' -%}     {%- set
                ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}  {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}        


                {%- set ns.heading_card_blank =
                  {
                    'type': 'heading',
                    'icon': ' ',
                    'heading': '',
                    'heading_style': 'title',
                  }
                -%}  {#-- Build a list of button entities for this kid --#} {%-
                set prefix = 'button\\.kc_' ~ (ns.Kid_name_normalize) ~
                '_chore_claim_' -%}   {%- set buttons = states.button |
                selectattr('entity_id', 'match', '^' ~ prefix) | list -%} 

                {#-- Use namespace to persist changes across loop iterations
                --#}  {%- for button in buttons -%}
                  {%- set today_00 = as_timestamp(now().date()) -%}
                  {%- set today_12 = today_00 + (12 * 60 * 60) -%}
                  {%- set today_24 = today_00 + ((24 * 60 * 60) - 1) -%}
                  {%- set chore_sensor_id = button.entity_id | regex_replace('^button\\.kc_', 'sensor.kc_') | regex_replace('_claim_', '_status_') -%}
                  {%- set sensor_state = states(chore_sensor_id) -%}
                  {%- set due_date_str = state_attr(chore_sensor_id, 'due_date') -%}
                  {%- if sensor_state == 'overdue' -%}
                    {%- set ns.overdue_buttons = ns.overdue_buttons + [button] -%}
                  {%- elif sensor_state == 'approved' and state_attr(chore_sensor_id,'allow_multiple_claims_per_day') == false and ns.pref_exclude_approved == true -%}
                    {#-- Do nothing --#}
                  {%- else -%}
                    {%- if due_date_str is not none and due_date_str != 'unknown' -%}
                      {%- set due_date_ts = as_timestamp(due_date_str) -%}
                      {%- if today_00 <= due_date_ts < today_24 -%}
                        {%- if due_date_ts < today_12 -%}
                          {%- set ns.am_buttons = ns.am_buttons + [button] -%}
                        {%- elif due_date_ts < today_24 -%}
                          {%- set ns.pm_buttons = ns.pm_buttons + [button] -%}
                        {%- else -%}
                          {%- set ns.other_buttons = ns.other_buttons + [button] -%}
                        {%- endif -%}
                      {%- else -%}
                        {%- set ns.other_buttons = ns.other_buttons + [button] -%}
                      {%- endif -%}
                    {%- else -%}
                      {%- set ns.other_buttons = ns.other_buttons + [button] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- set button_groups = [
                    {'name': ns.OVERDUE, 'buttons': ns.overdue_buttons, 'icon': 'mdi:alert-octagon'},
                    {'name': ns.THIS_MORNING, 'buttons': ns.am_buttons, 'icon': 'mdi:alarm'},
                    {'name': ns.TODAY, 'buttons': ns.pm_buttons, 'icon': 'mdi:calendar-today'},
                    {'name': ns.BONUS, 'buttons': ns.other_buttons, 'icon': 'mdi:calendar-clock'}
                ] -%}

                {%- for group in button_groups -%}
                  {%- if group.buttons | length > 0 -%}
                    {%- set heading_card =
                      {
                        'type': 'heading',
                        'icon': group.icon,
                        'heading': group.name,
                        'heading_style': 'title',
                      }
                    -%}
                    {{- heading_card -}},
                    {{- ns.heading_card_blank -}},          

                    {%- for button in group.buttons -%}
                      {%- set chore_sensor_id = button.entity_id | regex_replace('^button\\.kc_', 'sensor.kc_') | regex_replace('_claim_', '_status_') -%}
                      {%- set streak_chore_sensor_id = chore_sensor_id | regex_replace('_status_', '_streak_') -%}
                      {%- set primary = button.attributes.friendly_name.split(' - ')[2]~ (' (S)' if state_attr(chore_sensor_id, 'shared_chore') else '')  -%}
                      {%- if button.state not in ['unknown', 'unavailable', 'error'] -%}
                        {%- set ts_diff = (now().timestamp() - as_timestamp(button.state)) | float(0) -%}
                        {%- set last_update = (
                            '%.0f minutes ago' % (ts_diff / 60)
                            if ts_diff < 3600 else
                            '%.0f hours ago' % (ts_diff / 3600)
                            if ts_diff < 86400 else
                            '%.0f days ago' % (ts_diff / 86400)
                          ) -%}
                      {%- else -%}
                        {%- set last_update = '' -%}
                      {%- endif -%}
                      {%- set due_date_str = state_attr(chore_sensor_id, 'due_date') | string -%}
                      {%- set due_date = as_datetime(due_date_str).astimezone() if due_date_str and due_date_str not in ['None', 'unknown', 'unavailable'] else None -%}
                      {%- set today = now().astimezone().date() -%}
                      
                      {%- set due_date_short = 
                        'No due date' if not due_date 
                        else (
                          due_date.strftime('%-I:%M %p') if due_date.date() == today 
                          else due_date.strftime('%a %b %-d')
                        )
                      -%}   
                      {%- set multi_approve = state_attr(chore_sensor_id, 'allow_multiple_claims_per_day') -%}
                      {%- set chore_state = states(chore_sensor_id) -%}
                      {%- set chore_state_display = states(chore_sensor_id).title() ~ ' (M)' if multi_approve == true else states(chore_sensor_id).title() -%}
                      {%- set points = state_attr(chore_sensor_id, 'default_points') | string -%}
                      {%- set global_chore_state = state_attr(chore_sensor_id, 'global_state') -%}
                      {%- set multi_approve = state_attr(chore_sensor_id, 'allow_multiple_claims_per_day') -%}
                      {%- set streak = state_attr(chore_sensor_id, 'chore_current_streak') | string -%}              
                      {%- set secondary_options = 'Points: ' + points + '\n' + 'Streak: ' + streak + '\n' + 'Last: ' + last_update  + '\n \n' + 'Status: ' + chore_state + '\n' + 'Due: ' + due_date_short -%}
                      {%- set secondary = ns.points_label ~ ': ' + points + '\n' + ns.STREAK + ': ' + streak + '\n \n' + ns.STATUS + ': ' + chore_state_display + '\n' + ns.DUE + ': ' + due_date_short -%}
                      {%- set icon_color = (
                            'blue' if chore_state == 'approved' and multi_approve == true else
                            'green' if chore_state == 'approved' else
                            'yellow' if chore_state == 'partial' else
                            'orange' if chore_state == 'claimed' else
                            'red' if chore_state == 'overdue' else
                            'purple' if '_in_part' in global_chore_state else
                            'grey'
                          ) -%}
                      {%- set badge_color = (
                            'blue' if chore_state == 'approved' and multi_approve == true else
                            'green' if chore_state == 'approved' else
                            'green' if chore_state == 'partial' else
                            'green' if chore_state == 'claimed' else
                            'red' if chore_state == 'overdue' else
                            'purple' if '_in_part' in global_chore_state else
                            'grey'
                          ) -%}
                      {%- set badge_icon = (
                            'mdi:check-bold' if chore_state == 'approved' else
                            'mdi:check-bold' if chore_state == 'partial' else
                            'mdi:check-bold' if chore_state == 'claimed' else
                            'mdi:exclamation-thick' if chore_state == 'overdue' else
                            'mdi:account-group' if '_in_part' in global_chore_state else
                            ''
                          ) -%}
                      {{
                        {
                          'type': 'custom:mushroom-template-card',
                          'entity': button.entity_id,
                          'primary': primary,
                          'multiline_secondary': 'false',
                          'secondary': secondary,
                          'layout': 'horizontal',
                          'icon': button.attributes.icon,
                          'icon_color': icon_color,
                          'badge_icon': badge_icon,
                          'badge_color': badge_color,
                          'tap_action': {
                            'action': 'toggle'
                          },
                          'hold_action': {
                            'action': 'more-info'
                          },
                        }
                      }},
                    {%- endfor -%}

                    {%- if (group.buttons | length is odd) -%}{{ ns.heading_card_blank }},{%- endif -%}
                  {%- endif -%}
                {%- endfor -%}        
      - square: false
        type: grid
        columns: 1
        cards:
          - type: heading
            icon: mdi:star-settings
            heading: Belohnungen
            heading_style: title
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(
                  Kid_name='', Kid_name_normalize='',
                  current_points=0,
                  points_label='',
                  points_icon='',
                  reward_name_normalize='',
                  rewards=[],

                  COST='', NO_REWARDS=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.COST = "Cost: " -%}

                {%- set ns.NO_REWARDS = "No rewards available." -%} 



                {#-- ************* End Translatable Text ************* --#}



                {%- set ns.COST = "Kosten: " -%} 

                {%- set ns.NO_REWARDS = "Keine Belohnungen verfügbar." -%}  

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Point Labels -- #}   {%- set points_sensor = 'sensor.kc_'
                ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set
                ns.current_points = states(points_sensor) | int(default=0) -%}  
                {%- set ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}   {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Available Rewards -- #}   {%- set reward_prefix =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_reward_status_' -%}  
                {%- set reward_list = states.sensor | selectattr('entity_id',
                'match', reward_prefix ~ '.*') | list -%}  

                {%- for sensor in reward_list -%}
                  {%- set reward_name = state_attr(sensor.entity_id, 'reward_name') | default('Unknown') -%}
                  
                  {# -- Replace Accented Letters -- #}

                  {%- set ns.reward_name_normalize = reward_name -%} 
                  {%- for letter, replacement in replacements.items() -%}
                    {%- set ns.reward_name_normalize = ns.reward_name_normalize | replace(letter, replacement) -%}
                  {%- endfor -%}

                  {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                  {%- set ns.reward_name_normalize = ns.reward_name_normalize
                      | regex_replace("[^a-zA-Z0-9]", "_")
                      | regex_replace("_+", "_")
                      | regex_replace("^_", "")
                      | regex_replace("_$", "")
                      | lower
                  -%}
                  
                  {%- set reward_cost = state_attr(sensor.entity_id, 'cost') | int(default=0) -%}
                  {%- set reward_status = states(sensor.entity_id) | default('unknown') -%}
                  {%- set reward_icon = state_attr(sensor.entity_id, 'icon') | default('mdi:gift') -%}

                  {# -- Collect Approvals and Claims -- #}  
                  {%- set approval_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_reward_approvals_' ~ ns.reward_name_normalize -%}
                  {%- set claim_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_reward_claims_' ~ ns.reward_name_normalize -%}
                  {%- set claim_button = 'button.kc_' ~ ns.Kid_name_normalize ~ '_reward_claim_' ~ ns.reward_name_normalize -%}
                  {%- set approvals = states(approval_sensor) | int(default=0) -%}
                  {%- set claims = states(claim_sensor) | int(default=0) -%}

                  {# -- Check Points Availability -- #}  
                  {%- set points_needed = reward_cost - ns.current_points if reward_cost > ns.current_points else 0 -%}
                  {%- set can_claim = "✅" if points_needed == 0 else "❌ Need " ~ points_needed ~ " more" -%}

                  {# -- Add Reward Card to Grid -- #}  
                  {%- set ns.rewards = ns.rewards + [{
                    'type': 'custom:mushroom-template-card',
                    'primary': reward_name,
                    'secondary': "💰 " ~ ns.COST ~ reward_cost|string ~ " | 👍 " ~ approvals|string ~ " | 📥 " ~ claims|string ~ " | " ~ can_claim,
                    'icon': reward_icon,
                    'icon_color': 'green' if points_needed == 0 else 'grey',
                    'tap_action': { 'action': 'call-service', 'service': 'button.press', 'target': {'entity_id': claim_button } }
                  }] -%}
                {%- endfor -%}

                {{
                  {
                    'type': 'grid',
                    'columns': 1,
                    'square': false,
                    'cards': ns.rewards if ns.rewards | length > 0 else [{'type': 'markdown', 'content': ns.NO_REWARDS}]
                  }
                }},
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                points=0, points_label='', points_icon='', overdue=0,
                weekly_completed=0, todays_completed=0, all_time_completed='',
                all_badges=[], badge_list=[], badge_name_normalize='',
                badges_sensor='', highest_badge='', highest_badge_icon='',
                highest_badge_normalize='', highest_badge_entity='',
                highest_badge_multiplier='', highest_badge_display_line='',
                achievements=[], challenges=[], content='',

                  SHOWCASE='', TOTAL_COMPLETED='', HIGHEST_BADGE_EARNED='',
                  ACHIEVEMENTS='', CHALLENGES='', MULTIPLIER='', NONE='',
                  ALL_EARNED_BADGES='', COMPLETED=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.SHOWCASE = "Schaufenster" -%} 

                {%- set ns.TOTAL_COMPLETED = "Insgesamt erledigte Aufgaben" -%} 

                {%- set ns.HIGHEST_BADGE_EARNED = "Höchstes erhaltenes Abzeichen" -%} 

                {%- set ns.MULTIPLIER = "Multiplikator" -%}

                {%- set ns.ALL_EARNED_BADGES = "Alle erhaltenen Abzeichen" -%} 

                {%- set ns.NONE = "Keine" -%}

                {%- set ns.COMPLETED = "Erledigt" -%}

                {%- set ns.ACHIEVEMENTS = "Erfolge:" -%}

                {%- set ns.CHALLENGES = "Herausforderungen:" -%}  

                {#-- ************* End Translatable Text ************* --#}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Collect Points -- #}  {%- set points_sensor = 'sensor.kc_'
                ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set ns.points =
                states(points_sensor) | int(default=0) -%} {%- set
                ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%} {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Overdue Chores -- #}  {%- set
                chore_sensor_id_prefix = 'sensor.kc_'~ ns.Kid_name_normalize ~
                '_chore_status_' -%}   {%- set ns.overdue = states.sensor 
                    | selectattr('entity_id', 'match', '^' ~ chore_sensor_id_prefix ~ '.*') 
                    | selectattr('state', 'eq', 'overdue') 
                    | list | length | int(default=0) -%}

                {# -- Collect Weekly Completed -- #}  {%- set weekly_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_chores_completed_weekly' -%}  {%- set ns.weekly_completed =
                states(weekly_sensor) | int(default=0) -%}

                {# -- Collect Today's Completed -- #}  {%- set todays_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_chores_completed_daily'
                -%}  {%- set ns.todays_completed = states(todays_sensor) |
                int(default=0) -%}

                {# -- Collect Total Completed -- #}  {%- set all_time_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_chores_completed_total'
                -%}  {%- set ns.all_time_completed = states(all_time_sensor) |
                int(default=0) -%}

                {# -- Get Highest Badge Earned -- #}   

                {%- set highest_badge_sensor = 'sensor.kc_' ~
                ns.Kid_name_normalize ~ '_highest_badge' -%}    {%- set
                ns.highest_badge = states(highest_badge_sensor) or 'None' -%}  
                {%- set ns.highest_badge_icon = state_attr(highest_badge_sensor,
                'icon') or 'mdi:medal-outline' -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.highest_badge_normalize = ns.highest_badge -%}  {%-
                for letter, replacement in replacements.items() -%}
                  {%- set ns.highest_badge_normalize = ns.highest_badge_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.highest_badge_normalize = ns.highest_badge_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Get Multiplier for Highest Badge -- #}

                {%- set ns.highest_badge_entity = 'sensor.kc_' ~
                ns.highest_badge_normalize ~ '_badge' -%} {%- set
                ns.highest_badge_multiplier =
                state_attr(ns.highest_badge_entity, 'points_multiplier') |
                float(default=1) -%}

                {# -- Construct Badge Display Line for Markdown -- #}

                {%- if ns.highest_badge not in ['None', 'unknown', 'Unknown'] -%}
                  {%- set ns.badge_display_line = "<ha-icon icon='" ~ ns.highest_badge_icon ~ "'></ha-icon> " ~ ns.highest_badge ~ "  \n"  -%}
                {%- else -%}
                  {%- set ns.badge_display_line = ns.NONE -%}
                {%- endif -%}


                {# -- Get All Earned Badges -- #}  

                {%- set ns.all_badges = state_attr(highest_badge_sensor, 'all_earned_badges') | default([], true) -%}

                {# -- Construct the Badge List with Icons -- #}

                {%- set ns.badge_list = "\n " -%} {%- for badge in ns.all_badges
                -%}

                      {# -- Replace Accented Letters -- #}

                      {%- set ns.badge_name_normalize = badge -%}  {%- for
                      letter, replacement in replacements.items() -%}
                        {%- set ns.badge_name_normalize = ns.badge_name_normalize | replace(letter, replacement) -%}
                      {%- endfor -%}

                      {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                      {%- set ns.badge_name_normalize = ns.badge_name_normalize
                          | regex_replace("[^a-zA-Z0-9]", "_")
                          | regex_replace("_+", "_")
                          | regex_replace("^_", "")
                          | regex_replace("_$", "")
                          | lower
                      -%}

                  {%- set badge_sensor = 'sensor.kc_' ~ ns.badge_name_normalize ~ '_badge' -%}
                  {%- set badge_icon = state_attr(badge_sensor, 'icon') | default('mdi:medal-outline') -%}
                  {%- set ns.badge_list = ns.badge_list + "- <ha-icon icon='" ~ badge_icon ~ "'></ha-icon> " ~ badge ~ "  \n" -%}
                {%- endfor -%}



                {# -- Collect Achievements with Progress and Rewards -- #} {%-
                set achievement_prefix = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_achievement_status_' -%}   {%- set achievement_list =
                states.sensor | selectattr('entity_id', 'match',
                achievement_prefix ~ '.*') | list -%}   {%- for sensor in
                achievement_list -%}
                  {%- set name = state_attr(sensor.entity_id, 'achievement_name') | default('Unknown Achievement') -%}
                  {%- set icon = state_attr(sensor.entity_id, 'icon') or 'mdi:trophy-award' -%}
                  {%- set progress = states(sensor.entity_id) | float(default=0) -%}
                  {%- set award_status = state_attr(sensor.entity_id, 'awarded') -%}

                  {# -- Get Overall Sensor for Reward Points -- #}
                  {%- set overall_sensor = sensor.entity_id | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}

                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = ns.COMPLETED if award_status == 'true' else '⌛ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.achievements = ns.achievements + ["- " ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", 💎 " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {# -- Collect Challenges with Progress and Rewards -- #} {%- set
                challenge_prefix = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_challenge_status_' -%}   {%- set challenge_list =
                states.sensor | selectattr('entity_id', 'match',
                challenge_prefix ~ '.*') | list -%}   {%- for sensor in
                challenge_list -%}
                  {%- set name = state_attr(sensor.entity_id, 'challenge_name') | default('Unknown Challenge') -%}
                  {%- set icon = state_attr(sensor.entity_id, 'icon') or 'mdi:flag-checkered' -%}
                  {%- set progress = states(sensor.entity_id) | float(default=0) -%}
                  {%- set award_status = state_attr(sensor.entity_id, 'awarded') -%}

                  {# -- Get Overall Sensor for Reward Points -- #}
                  {%- set overall_sensor = sensor.entity_id | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}
                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = "✔️ " ~ ns.COMPLETED if award_status == 'true' else '⌛ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.challenges = ns.challenges + ["- " ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", 💎 " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {#-- Create Content Variable --#}  

                {%- set ns.content = 
                  "## 🏅 " ~ ns.Kid_name ~ "’s " ~ ns.SHOWCASE ~ "  \n"
                  "<ha-icon icon=" ~ ns.points_icon ~ "></ha-icon>" ~ "&nbsp;&nbsp;**" ~ ns.points_label ~ ":** &nbsp;&nbsp;" ~ ns.points ~ " \n\n"
                  "<ha-icon icon=" ~ 'mdi:broom' ~ "></ha-icon>" ~ "&nbsp;&nbsp;**" ~ ns.TOTAL_COMPLETED ~ ":** &nbsp;&nbsp;" ~ ns.all_time_completed ~ " \n\n"  
                  "**🥇 " ~ ns.HIGHEST_BADGE_EARNED ~ ":** &nbsp;&nbsp;" ~ ns.badge_display_line ~ "  \n"
                  "**💎 " ~ ns.points_label ~ " " ~ ns.MULTIPLIER ~ ":** &nbsp;&nbsp;x" ~ ns.highest_badge_multiplier ~ "  \n\n"
                  "**🥇 " ~ ns.ALL_EARNED_BADGES ~ ":**  " ~ (ns.badge_list if ns.all_badges | length > 0 else "&nbsp;" ~ ns.NONE) ~ "  \n"
                  "#### 🏆 " ~ ns.ACHIEVEMENTS ~ ": &nbsp;&nbsp; " ~ 
                  ('\n' ~ ('\n'.join(ns.achievements)) if ns.achievements | length > 0 else "&nbsp;" ~ ns.NONE) ~ "  \n"
                  "#### 🏁 " ~ ns.CHALLENGES ~ ": &nbsp;&nbsp; " ~ 
                  ('\n' ~ ('\n'.join(ns.challenges)) if ns.challenges | length > 0 else "&nbsp;" ~ ns.NONE) ~ "  \n"
                -%}

                {{
                  {
                    'type': 'markdown',
                    'content': ns.content
                  }
                }},
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- Initialize Namespace Variables --#}  

                {%- set ns = namespace(
                  Kid_name='',
                  Kid_name_normalize='',
                  current_points='',
                  points_label='',
                  achievements=[],

                  NO_ACHIEVEMENTS_FOUND='',
                  START_A_ACHIEVEMENT='',
                  ACHIEVEMENT_LABEL='',
                  AWARD_STATUS_LABEL='',
                  EARNED_LABEL='',
                  IN_PROCESS_LABEL='',
                  DESCRIPTION_LABEL='',
                  CRITERIA_LABEL='',
                  GOAL_LABEL='',
                  START_DATE_LABEL='',
                  END_DATE_LABEL='',
                  REWARD_LABEL='',
                  PROGRESS_LABEL='',
                  ASSIGNED_TO_LABEL='',
                  RELATED_CHORE_LABEL='',
                  TOTAL_CHORES='',
                  PER_DAY_GOAL='',
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.NO_ACHIEVEMENTS_FOUND = "Keine Erfolge gefunden" -%} 

                {%- set ns.START_A_ACHIEVEMENT = "Starte einen Erfolg, um deinen Fortschritt zu verfolgen!" -%} 

                {%- set ns.ACHIEVEMENT_LABEL = "Erfolg" -%} 

                {%- set ns.AWARD_STATUS_LABEL = "Auszeichnungsstatus" -%}  

                {%- set ns.EARNED_LABEL = "Erhalten" -%}  

                {%- set ns.IN_PROCESS_LABEL = "In Bearbeitung" -%}  

                {%- set ns.DESCRIPTION_LABEL = "Beschreibung" -%}  

                {%- set ns.CRITERIA_LABEL = "Kriterien" -%}  

                {%- set ns.GOAL_LABEL = "Ziel" -%}  

                {%- set ns.START_DATE_LABEL = "Startdatum" -%}  

                {%- set ns.END_DATE_LABEL = "Enddatum" -%}  

                {%- set ns.REWARD_LABEL = "Belohnung" -%}  

                {%- set ns.PROGRESS_LABEL = "Fortschritt" -%}  

                {%- set ns.ASSIGNED_TO_LABEL = "Zugewiesen an" -%}  

                {%- set ns.RELATED_CHORE_LABEL = "Zugehörige Aufgabe" -%}

                {%- set ns.TOTAL_CHORES = "Gesamtanzahl Aufgaben" -%}

                {%- set ns.PER_DAY_GOAL = "Tagesziel" -%}  

                {#-- ************* End Translatable Text ************* --#}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%}  {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Point Labels -- #}      {%- set points_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set
                ns.current_points = states(points_sensor) | int(default=0) -%}  
                {%- set ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}   {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Achievements -- #}  {%- set achievement_prefix =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_achievement_status_'
                -%}  {%- set achievements = states.sensor |
                selectattr('entity_id', 'match', achievement_prefix ~ '.*') |
                list -%}

                {%- if achievements | length == 0 -%}
                  {{
                    {
                      'type': 'markdown',
                      'content': "### 🏁 " ~ ns.NO_ACHIEVEMENTS_FOUND ~ "  \n" ~ ns.START_A_ACHIEVEMENT
                    }
                  }},
                {%- else -%}
                  {%- for achievement_sensor in achievements -%}
                    {%- set achievement_name = state_attr(achievement_sensor.entity_id, 'achievement_name') | default('Unknown') -%}
                    {%- set achievement_icon = state_attr(achievement_sensor.entity_id, 'icon') or 'mdi:flag-checkered' -%}            
                    {%- set achievement_overall_sensor = achievement_sensor.entity_id | regex_replace('^sensor\.kc_[a-zA-Z0-9_]+_achievement_status_', 'sensor.kc_achievement_status_') -%}
                    {%- set target_value = state_attr(achievement_sensor.entity_id, 'target_value') | int(default=0) -%}
                    {%- set raw_progress = state_attr(achievement_sensor.entity_id, 'raw_progress') | float(default=0) -%}
                    {%- set awarded = state_attr(achievement_sensor.entity_id, 'awarded') | default(false) -%}
                    {%- set reward_points = state_attr(achievement_overall_sensor, 'reward_points') | int(default=0) -%}
                    {%- set achievement_type = state_attr(achievement_overall_sensor, 'type') | default('total_within_window') -%}
                    {%- set progress_percentage = ((raw_progress / target_value) * 100) | round(1) if target_value > 0 else 0 -%}
                    {%- set associated_chore = state_attr(achievement_sensor.entity_id, 'associated_chore') | default('') -%}
                    {%- set description = state_attr(achievement_sensor.entity_id, 'description') | default('') -%}
                    {%- set criteria = state_attr(achievement_sensor.entity_id, 'criteria') | default('') -%}
                    {%- set assigned_kids = state_attr(achievement_sensor.entity_id, 'assigned_kids') | default([]) -%}
                  
                    {%- set awarded_text = "✔️ " ~ ns.EARNED_LABEL if awarded else "⌛ " ~ ns.IN_PROCESS_LABEL -%}
                    {%- set goal_type_label = target_value ~ ' (' ~ ns.TOTAL_CHORES ~ ')' if achievement_type == 'total_within_window' else target_value ~ ' (' ~ ns.PER_DAY_GOAL ~ ')' -%}
                    {%- set kids_display = assigned_kids | join(', ') if assigned_kids | count > 0 else '' -%}


                    {%- set content = "## <ha-icon icon=" ~ achievement_icon ~ "></ha-icon> " ~ ns.ACHIEVEMENT_LABEL ~ ": " ~ achievement_name ~ "  \n" %}
                    {%- set content = content ~ "### 🏅 " ~ ns.AWARD_STATUS_LABEL ~ ": &nbsp;&nbsp;" ~ awarded_text ~ "  \n" %}
                    {%- if description -%}
                      {%- set content = content ~ "#### 📖 &nbsp;&nbsp;" ~ description ~ "  \n" %}
                    {%- endif -%}
                    {%- if criteria -%}
                      {%- set content = content ~ "**📌 " ~ ns.CRITERIA_LABEL ~ ":** &nbsp;&nbsp;" ~ criteria ~ "  \n" %}
                    {%- endif -%}
                    {%- set content = content ~ "**🎯 " ~ ns.GOAL_LABEL ~ ":** &nbsp;&nbsp;" ~ goal_type_label ~ "  \n" %}
                    {%- if reward_points > 0 -%}
                      {%- set content = content ~ "**💎 " ~ ns.REWARD_LABEL ~ ":** &nbsp;&nbsp;" ~ reward_points|string ~ " " ~ ns.points_label ~ " \n" %}
                    {%- endif -%}
                    {%- set content = content ~ "\n **📊 " ~ ns.PROGRESS_LABEL ~ ":** &nbsp;&nbsp;" ~ raw_progress|int|string ~ "/" ~ target_value|string ~ " (" ~ progress_percentage|string ~ "%)  \n" %}
                    {%- if kids_display -%}
                      {%- set content = content ~ "**👥 " ~ ns.ASSIGNED_TO_LABEL ~ ":** &nbsp;&nbsp;" ~ kids_display ~ "  \n" %}
                    {%- endif -%}
                    {%- if associated_chore -%}
                      {%- set content = content ~ "**🛠 " ~ ns.RELATED_CHORE_LABEL ~ ":** &nbsp;&nbsp;" ~ associated_chore ~ "  \n" %}
                    {%- endif -%}  

                    {{
                      {
                        'type': 'markdown',
                        'content': content
                      }
                    }},
                  {%- endfor -%}
                {%- endif -%}
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- Initialize Namespace Variables --#}  

                {%- set ns = namespace(
                  Kid_name='',
                  Kid_name_normalize='',
                  current_points='',
                  points_label='',
                  challenges=[],

                  NO_CHALLENGES_FOUND='',
                  START_A_CHALLENGE='',
                  CHALLENGE_LABEL='',
                  AWARD_STATUS_LABEL='',
                  EARNED_LABEL='',
                  IN_PROCESS_LABEL='',
                  DESCRIPTION_LABEL='',
                  CRITERIA_LABEL='',
                  GOAL_LABEL='',
                  START_DATE_LABEL='',
                  END_DATE_LABEL='',
                  REWARD_LABEL='',
                  PROGRESS_LABEL='',
                  ASSIGNED_TO_LABEL='',
                  RELATED_CHORE_LABEL='',
                  TOTAL_CHORES='',
                  PER_DAY_GOAL='',
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.NO_CHALLENGES_FOUND = "Keine Herausforderungen gefunden" -%} 

                {%- set ns.START_A_CHALLENGE = "Starte eine Herausforderung, um deine Grenzen zu testen!" -%} 

                {%- set ns.CHALLENGE_LABEL = "Herausforderung" -%} 

                {%- set ns.AWARD_STATUS_LABEL = "Auszeichnungsstatus" -%}  

                {%- set ns.EARNED_LABEL = "Erhalten" -%}  

                {%- set ns.IN_PROCESS_LABEL = "In Bearbeitung" -%}  

                {%- set ns.DESCRIPTION_LABEL = "Beschreibung" -%}  

                {%- set ns.CRITERIA_LABEL = "Kriterien" -%}  

                {%- set ns.GOAL_LABEL = "Ziel" -%}  

                {%- set ns.START_DATE_LABEL = "Startdatum" -%}  

                {%- set ns.END_DATE_LABEL = "Enddatum" -%}  

                {%- set ns.REWARD_LABEL = "Belohnung" -%}  

                {%- set ns.PROGRESS_LABEL = "Fortschritt" -%}  

                {%- set ns.ASSIGNED_TO_LABEL = "Zugewiesen an" -%}  

                {%- set ns.RELATED_CHORE_LABEL = "Zugehörige Aufgabe" -%}

                {%- set ns.TOTAL_CHORES = "Gesamtanzahl Aufgaben" -%}

                {%- set ns.PER_DAY_GOAL = "Tagesziel" -%}  

                {#-- ************* End Translatable Text ************* --#}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%}  {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Point Labels -- #}      {%- set points_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set
                ns.current_points = states(points_sensor) | int(default=0) -%}  
                {%- set ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}   {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Challenges -- #}  {%- set challenge_prefix =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_challenge_status_' -%} 
                {%- set challenges = states.sensor | selectattr('entity_id',
                'match', challenge_prefix ~ '.*') | list -%}

                {%- if challenges | length == 0 -%}
                  {{
                    {
                      'type': 'markdown',
                      'content': "### 🏁 " ~ ns.NO_CHALLENGES_FOUND ~ "  \n" ~ ns.START_A_CHALLENGE
                    }
                  }},
                {%- else -%}
                  {%- for challenge_sensor in challenges -%}
                    {%- set challenge_name = state_attr(challenge_sensor.entity_id, 'challenge_name') | default('Unknown') -%}
                    {%- set challenge_icon = state_attr(challenge_sensor.entity_id, 'icon') or 'mdi:flag-checkered' -%}            
                    {%- set challenge_overall_sensor = challenge_sensor.entity_id | regex_replace('^sensor\.kc_[a-zA-Z0-9_]+_challenge_status_', 'sensor.kc_challenge_status_') -%}
                    {%- set target_value = state_attr(challenge_sensor.entity_id, 'target_value') | int(default=0) -%}
                    {%- set raw_progress = state_attr(challenge_sensor.entity_id, 'raw_progress') | float(default=0) -%}
                    {%- set awarded = state_attr(challenge_sensor.entity_id, 'awarded') | default(false) -%}
                    {%- set reward_points = state_attr(challenge_overall_sensor, 'reward_points') | int(default=0) -%}
                    {%- set challenge_type = state_attr(challenge_overall_sensor, 'type') | default('total_within_window') -%}
                    {%- set progress_percentage = ((raw_progress / target_value) * 100) | round(1) if target_value > 0 else 0 -%}
                    {%- set associated_chore = state_attr(challenge_sensor.entity_id, 'associated_chore') | default('') -%}
                    {%- set description = state_attr(challenge_sensor.entity_id, 'description') | default('') -%}
                    {%- set criteria = state_attr(challenge_sensor.entity_id, 'criteria') | default('') -%}
                    {%- set assigned_kids = state_attr(challenge_sensor.entity_id, 'assigned_kids') | default([]) -%}
                  
                    {%- set awarded_text = "✔️ " ~ ns.EARNED_LABEL if awarded else "⌛ " ~ ns.IN_PROCESS_LABEL -%}
                    {%- set goal_type_label = target_value ~ ' (' ~ ns.TOTAL_CHORES ~ ')' if challenge_type == 'total_within_window' else target_value ~ ' (' ~ ns.PER_DAY_GOAL ~ ')' -%}
                    {%- set kids_display = assigned_kids | join(', ') if assigned_kids | count > 0 else '' -%}
                    {# Convert start and end dates to local time and short format #}
                    {%- set start_date_utc = state_attr(challenge_overall_sensor, 'start_date') -%}
                    {%- set end_date_utc = state_attr(challenge_overall_sensor, 'end_date') -%}
                    {%- set start_date = as_datetime(start_date_utc).astimezone().strftime('%b %d, %Y') if start_date_utc else 'N/A' -%}
                    {%- set end_date = as_datetime(end_date_utc).astimezone().strftime('%b %d, %Y') if end_date_utc else 'N/A' -%}


                    {%- set content = "## <ha-icon icon=" ~ challenge_icon ~ "></ha-icon> " ~ ns.CHALLENGE_LABEL ~ ": " ~ challenge_name ~ "  \n" %}
                    {%- set content = content ~ "### 🏅 " ~ ns.AWARD_STATUS_LABEL ~ ": &nbsp;&nbsp;" ~ awarded_text ~ "  \n" %}
                    {%- if description -%}
                      {%- set content = content ~ "#### 📖 &nbsp;&nbsp;" ~ description ~ "  \n" %}
                    {%- endif -%}
                    {%- if criteria -%}
                      {%- set content = content ~ "**📌 " ~ ns.CRITERIA_LABEL ~ ":** &nbsp;&nbsp;" ~ criteria ~ "  \n" %}
                    {%- endif -%}
                    {%- set content = content ~ "**🎯 " ~ ns.GOAL_LABEL ~ ":** &nbsp;&nbsp;" ~ goal_type_label ~ "  \n" %}
                    {%- set content = content ~ "**📅 " ~ ns.START_DATE_LABEL ~ ":** &nbsp;&nbsp;" ~ start_date ~ "  \n" %}
                    {%- set content = content ~ "**📅 " ~ ns.END_DATE_LABEL ~ ":** &nbsp;&nbsp;" ~ end_date ~ "  \n" %}
                    {%- if reward_points > 0 -%}
                      {%- set content = content ~ "**💎 " ~ ns.REWARD_LABEL ~ ":** &nbsp;&nbsp;" ~ reward_points|string ~ " " ~ ns.points_label ~ " \n" %}
                    {%- endif -%}
                    {%- set content = content ~ "\n **📊 " ~ ns.PROGRESS_LABEL ~ ":** &nbsp;&nbsp;" ~ raw_progress|int|string ~ "/" ~ target_value|string ~ " (" ~ progress_percentage|string ~ "%)  \n" %}
                    {%- if kids_display -%}
                      {%- set content = content ~ "**👥 " ~ ns.ASSIGNED_TO_LABEL ~ ":** &nbsp;&nbsp;" ~ kids_display ~ "  \n" %}
                    {%- endif -%}
                    {%- if associated_chore -%}
                      {%- set content = content ~ "**🛠 " ~ ns.RELATED_CHORE_LABEL ~ ":** &nbsp;&nbsp;" ~ associated_chore ~ "  \n" %}
                    {%- endif -%}  

                    {{
                      {
                        'type': 'markdown',
                        'content': content
                      }
                    }},
                  {%- endfor -%}
                {%- endif -%}
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(
                  Kid_name='',
                  Kid_name_normalize='',
                  points=0,
                  points_label='',
                  points_icon='',
                  todays_completed=0,
                  weekly_completed=0,
                  monthly_completed=0,
                  overdue_chores=0,
                  earned_rewards=[],
                  total_penalty_points=0,
                  penalties=[],
                  reward_progress=[],

                   PARENT_DASHBOARD_LABEL='',
                  CHORES_COMPLETED_LABEL='',
                  TODAY_LABEL='',
                  WEEK_LABEL='',
                  MONTH_LABEL='',
                  OVERDUE_CHORES_LABEL='',
                  REWARDS_LABEL='',
                  PENALTIES_APPLIED_LABEL='',
                  TOTAL_PENALTY_LABEL='',
                  NONE_LABEL=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.PARENT_DASHBOARD_LABEL = "Eltern-Dashboard für" -%} 

                {%- set ns.CHORES_COMPLETED_LABEL = "Erledigte Aufgaben" -%} 

                {%- set ns.TODAY_LABEL = "Heute" -%} 

                {%- set ns.WEEK_LABEL = "Woche" -%}  

                {%- set ns.MONTH_LABEL = "Monat" -%}  

                {%- set ns.OVERDUE_CHORES_LABEL = "Überfällige Aufgaben" -%}  

                {%- set ns.REWARDS_LABEL = "Belohnungen" -%}  

                {%- set ns.PENALTIES_APPLIED_LABEL = "Angewandte Strafen" -%}  

                {%- set ns.TOTAL_PENALTY_LABEL = "Gesamtstrafe" -%}  

                {%- set ns.NONE_LABEL = "Keine" -%}  

                {#-- ************* End Translatable Text ************* --#}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Collect Points Info -- #}   {%- set points_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%}   {%- set
                ns.points = states(points_sensor) | int(default=0) -%}   {%- set
                ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}   {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {# -- Collect Chores Completed: Today, Week, Month -- #}   {%-
                set todays_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_chores_completed_daily' -%}   {%- set weekly_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_chores_completed_weekly' -%}   {%- set monthly_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_chores_completed_monthly' -%}   {%- set ns.todays_completed =
                states(todays_sensor) | int(default=0) -%}   {%- set
                ns.weekly_completed = states(weekly_sensor) | int(default=0)
                -%}   {%- set ns.monthly_completed = states(monthly_sensor) |
                int(default=0) -%}  

                {# -- Collect Overdue Chores -- #}   {%- set chore_sensor_prefix
                = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_chore_status_' -%}  
                {%- set overdue = states.sensor  
                    | selectattr('entity_id', 'match', '^' ~ chore_sensor_prefix ~ '.*')  
                    | selectattr('state', 'eq', 'overdue')  
                    | list  
                    | length  
                -%}   {%- set ns.overdue_chores = overdue | int(default=0) -%}  

                {# -- Collect Earned Rewards (Claims & Approvals) -- #}   {%-
                set reward_claims_prefix = 'sensor.kc_' ~ ns.Kid_name_normalize
                ~ '_reward_claims_' -%}   {%- set reward_approvals_prefix =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_reward_approvals_'
                -%}   {%- set reward_claims = states.sensor |
                selectattr('entity_id', 'match', reward_claims_prefix ~ '.*') |
                list -%}   {%- set reward_approvals = states.sensor |
                selectattr('entity_id', 'match', reward_approvals_prefix ~ '.*')
                | list -%}  

                {%- for claim_sensor in reward_claims -%}
                  {%- set status_sensor = claim_sensor.entity_id | regex_replace('_claims_', '_status_') -%}
                  {%- set reward_name = state_attr(status_sensor, 'reward_name') | default('Unknown Reward') -%}
                  {%- set reward_icon = state_attr(status_sensor, 'icon') | default('mdi:gift') -%}
                  {%- set claim_count = states(claim_sensor.entity_id) | int(default=0) -%}

                  {%- set approval_sensor = claim_sensor.entity_id | regex_replace('_claims_', '_approvals_') -%}
                  {%- set approval_count = states(approval_sensor) | int(default=0) -%}

                  {%- if claim_count > 0 or approval_count > 0 -%}
                    {%- set ns.reward_progress = ns.reward_progress + [
                      "- <ha-icon icon='" ~ reward_icon ~ "'></ha-icon> **" ~ reward_name ~ ":** &nbsp;&nbsp; Claims: &nbsp;" 
                      ~ claim_count ~ "&nbsp; |&nbsp; Approvals: &nbsp;" ~ approval_count
                    ] -%}
                  {%- endif -%}
                {%- endfor -%}

                {# -- Collect Penalties Applied -- #}   {%- set penalty_prefix =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_penalties_applied_'
                -%}   {%- set penalty_list = states.sensor |
                selectattr('entity_id', 'match', penalty_prefix ~ '.*') | list
                -%}   {%- for sensor in penalty_list -%}
                  {%- set penalty_name = state_attr(sensor.entity_id, 'penalty_name') | default('Unknown Penalty') -%}
                  {%- set penalty_icon = state_attr(sensor.entity_id, 'icon') | default('mdi:alert') -%}
                  {%- set penalty_points = state_attr(sensor.entity_id, 'penalty_points') | float(default=0) -%}
                  {%- set penalty_count = states(sensor.entity_id) | int(default=0) -%}

                  {%- if penalty_count > 0 -%}
                    {%- set ns.total_penalty_points = ns.total_penalty_points + (-penalty_points * penalty_count) -%}
                    {%- set ns.penalties = ns.penalties + [
                      "- <ha-icon icon='" ~ penalty_icon ~ "'></ha-icon> **" ~ penalty_name ~ ":** Applied " 
                      ~ penalty_count ~ " times (💥 " ~ (-penalty_points * penalty_count) ~ " " ~ ns.points_label ~ ")"
                    ] -%}
                  {%- endif -%}
                {%- endfor -%}

                {#-- Store the Markdown content in a variable --#}

                {#-- Store the Markdown content in a variable --#} {%- set
                content = 
                  "## 👨‍👩‍👧 " ~ ns.PARENT_DASHBOARD_LABEL ~ " " ~ ns.Kid_name ~ "  \n"
                  "<ha-icon icon=" ~ ns.points_icon ~ "></ha-icon> **" ~ ns.points_label ~ ":** &nbsp;&nbsp;" ~ ns.points ~ "  \n"
                  "#### 📅 " ~ ns.CHORES_COMPLETED_LABEL ~ ":  \n"
                  "- ☀️ " ~ ns.TODAY_LABEL ~ ": &nbsp;&nbsp;" ~ ns.todays_completed ~ "  \n"
                  "- 📅 " ~ ns.WEEK_LABEL ~ ": &nbsp;&nbsp;" ~ ns.weekly_completed ~ "  \n"
                  "- 🗓️ " ~ ns.MONTH_LABEL ~ ": &nbsp;&nbsp;" ~ ns.monthly_completed ~ "  \n"
                  "- 🚨 " ~ ns.OVERDUE_CHORES_LABEL ~ ": &nbsp;&nbsp;" ~ ns.overdue_chores ~ "  \n\n"
                  "#### 💰 " ~ ns.REWARDS_LABEL ~ ": &nbsp;&nbsp;" ~ 
                  ("\n" ~ ('\n'.join(ns.reward_progress)) if ns.reward_progress | length > 0 else ns.NONE_LABEL) ~ "  \n\n"
                  "#### ⚠️ " ~ ns.PENALTIES_APPLIED_LABEL ~ ": &nbsp;&nbsp;" ~ 
                  ("\n" ~ ('\n'.join(ns.penalties)) if ns.penalties | length > 0 else ns.NONE_LABEL) ~ "  \n"
                  "**💥 " ~ ns.TOTAL_PENALTY_LABEL ~ " " ~ ns.points_label ~ ":** &nbsp;&nbsp;" ~ ns.total_penalty_points ~ "  \n"
                -%}

                {#-- Use the content variable inside the markdown card --#}

                {{
                  {
                    'type': 'markdown',
                    'content': content
                  }
                }},
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 2
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                approve_chore_buttons=[], approve_reward_buttons=[],
                heading_card_blank='', has_approvals='false',
                chore_name_normalize='', reward_name_normalize='',
                CHORE_APPROVALS='', REWARD_APPROVALS='', OK='', NO='') -%}  

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.CHORE_APPROVALS = "Aufgabenfreigaben" -%} 

                {%- set ns.REWARD_APPROVALS = "Belohnungsfreigaben" -%} 

                {%- set ns.OK = "OK" -%} 

                {%- set ns.NO = "NEIN" -%}  

                {#-- ************* End Translatable Text ************* --#}

                {%- set ns.Kid_name = 'Kidname'-%} 

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #} {%- set
                ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #} {%-
                set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower    
                -%}

                {%- set ns.heading_card_blank =
                  {
                    'type': 'heading',
                    'icon': ' ',
                    'heading': '',
                    'heading_style': 'title',
                  }
                -%}    

                {%- set pending_chore_data =
                state_attr('sensor.kc_global_chore_pending_approvals',
                ns.Kid_name) | default([], true) if
                states('sensor.kc_global_chore_pending_approvals') not in
                ['unavailable', 'unknown'] else
                state_attr('sensor.kc_pending_chore_approvals', ns.Kid_name) |
                default([], true) if states('sensor.kc_pending_chore_approvals')
                not in ['unavailable', 'unknown'] else  [{'chore_name': 'error',
                'Claimed on':'2000-01-01'}] -%}


                {%- set pending_reward_data =
                state_attr('sensor.kc_global_reward_pending_approvals',
                ns.Kid_name) | default([], true) | default([], true) |
                default([], true) if
                states('sensor.kc_global_reward_pending_approvals') not in
                ['unavailable', 'unknown'] else
                state_attr('sensor.kc_global_pending_reward_approvals',
                ns.Kid_name) | default([], true) | default([], true) if
                states('sensor.kc_global_pending_reward_approvals') not in
                ['unavailable', 'unknown'] else
                state_attr('sensor.kc_pending_reward_approvals', ns.Kid_name) |
                default([], true) if
                states('sensor.kc_pending_reward_approvals') not in
                ['unavailable', 'unknown'] else  [{'reward_name': 'error',
                'Redeemed on': '2000-01-01'}] -%}


                {%- if pending_chore_data | count > 0 -%}
                  {%- for chore in pending_chore_data | unique(attribute='chore_name') -%}
                    {%- set ns.chore_name_normalize = chore.chore_name -%}  
                    {%- for letter, replacement in replacements.items() -%}
                      {%- set ns.chore_name_normalize = ns.chore_name_normalize | replace(letter, replacement) -%}
                    {%- endfor -%} 
                      {# -- Convert All Non-Alphanumeric Characters to "_" -- #}
                      {%- set ns.chore_name_normalize = ns.chore_name_normalize
                          | regex_replace("[^a-zA-Z0-9]", "_")
                          | regex_replace("_+", "_")
                          | regex_replace("^_", "")
                          | regex_replace("_$", "")
                          | lower    
                      -%}
                    {%- set ns.approve_chore_buttons = ns.approve_chore_buttons + ['button.kc_' ~ ns.Kid_name_normalize ~ '_chore_approval_' ~ ns.chore_name_normalize] + ['button.kc_' ~ ns.Kid_name_normalize ~ '_chore_disapproval_' ~ ns.chore_name_normalize]-%}
                  {%- endfor -%}
                {%- endif -%} {%- if pending_reward_data | count > 0 -%}
                  {%- for reward in pending_reward_data | unique(attribute='reward_name') -%}
                    {%- set ns.reward_name_normalize = reward.reward_name -%}  
                    {%- for letter, replacement in replacements.items() -%}
                      {%- set ns.reward_name_normalize = ns.reward_name_normalize | replace(letter, replacement) -%}
                    {%- endfor -%} 
                    {# -- Convert All Non-Alphanumeric Characters to "_" -- #}
                    {%- set ns.reward_name_normalize = ns.reward_name_normalize
                        | regex_replace("[^a-zA-Z0-9]", "_")
                        | regex_replace("_+", "_")
                        | regex_replace("^_", "")
                        | regex_replace("_$", "")
                        | lower    
                    -%}
                    {%- set ns.approve_reward_buttons = ns.approve_reward_buttons + ['button.kc_' ~ ns.Kid_name_normalize ~ '_reward_approval_' ~ ns.reward_name_normalize] + ['button.kc_' ~ ns.Kid_name_normalize ~ '_reward_disapproval_' ~ ns.reward_name_normalize]-%}
                  {%- endfor -%}
                {%- endif -%}

                {%- set button_groups = [
                    {'name': ns.CHORE_APPROVALS, 'buttons': ns.approve_chore_buttons, 'icon': 'mdi:thumb-up-outline'},
                    {'name': ns.REWARD_APPROVALS, 'buttons': ns.approve_reward_buttons, 'icon': 'mdi:thumb-up-outline'},
                ] -%}

                {%- for group in button_groups -%}
                  {%- if group.buttons | length > 0 -%}
                    {%- set ns.has_approvals = 'true' -%}
                    {%- set heading_card =
                      {
                        'type': 'heading',
                        'icon': group.icon,
                        'heading': group.name,
                        'heading_style': 'title',
                      }
                    -%}
                    {{- heading_card -}},
                    {{- ns.heading_card_blank -}},          

                    {%- for button in group.buttons -%}
                      {%- set sensor_id = button 
                          | regex_replace('^button\\.kc_', 'sensor.kc_') 
                          | regex_replace('_(approval|disapproval)_', '_status_') 
                      -%}

                      {%- set primary = 
                          (ns.OK ~ ': ' ~ state_attr(button, 'friendly_name') | regex_replace('^[^-]+ - ([^ ]+) .* - (.*)$', '\\2')) 
                          if button | regex_search('_approval_') 
                          else 
                          (ns.NO ~ ': ' ~ state_attr(button, 'friendly_name') | regex_replace('^[^-]+ - ([^ ]+) .* - (.*)$', '\\2')) 
                      -%}
                      {%- set icon = 
                          'mdi:thumb-up' if '_approval_' in button else 
                          'mdi:thumb-down' if '_disapproval_' in button else 
                          'mdi:progress-question' 
                      -%}
                      {%- set icon_color = 
                          'green' if '_approval_' in button else 
                          'red' if '_disapproval_' in button else 
                          'grey'
                      -%}
                      {{
                        {
                          'type': 'custom:mushroom-template-card',
                          'entity': button,
                          'primary': primary,
                          'icon': icon,
                          'layout': '',
                          'icon_color': icon_color,
                          'tap_action': {
                            'action': 'toggle'
                          },
                          'hold_action': {
                            'action': 'more-info'
                          },
                        }
                      }},
                    {%- endfor -%}
                    {%- if (group.buttons | length is odd) -%}{{ ns.heading_card_blank }},{%-endif -%}
                  {%- endif -%}
                {%- endfor -%} 
      - square: false
        type: grid
        columns: 1
        cards:
          - type: heading
            icon: mdi:rocket-launch
            heading_style: title
            heading: Aufgaben Admin Aktionen
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(
                  Kid_name='',
                  Kid_name_normalize='',
                  replacements=[],
                  chore_select_entity='',
                  chore_selected='',
                  chore_selected_normalize='',
                  chore_sensor_id_prefix='',
                  chore_sensor_id='',
                  current_status='',
                  chore_description='',
                  chore_days='',
                  chore_allow_multiple='',
                  global_status='Unknown',
                  shared_chore='False',
                  due_date_formatted='None',
                  recurrence='Not Recurring',
                  chore_icon='mdi:clipboard-check',
                  chore_value='N/A',
                  points='',
                  points_label='',
                  points_icon='',
                  content='',
                  select_new_date_and_time_secondary='',

                  SELECT_CHORE_TO_EDIT_DUE_DATE='',
                  CHORE_DETAIL_LABEL='',
                  CURRENT_STATUS_LABEL='',
                  GLOBAL_STATUS_LABEL='',
                  SHARED_CHORE_LABEL='',
                  VALUE_LABEL='',
                  DUE_DATE_LABEL='',
                  RECURRENCE_LABEL='',
                  NO_CHORE_SELECTED_LABEL='',
                  PLUS_NEXT_DUE='',
                  PLUS_1_DAY='',
                  PLUS_1_WEEK='',
                  CLEAR_DATE='',
                  SELECT_NEW_DATE_AND_TIME='',
                  TAP_TO_CHANGE_HOLD_TO_SET='',
                  RESET_ALL='',
                  OVERDUE_CHORES='',
                  RESET_OVERDUE_STATUS='',
                  ALLOW_MULTIPLE_CLAIMS='',
                  APPLICABLE_DAYS=''
                ) -%}  


                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.SELECT_CHORE_TO_EDIT_DUE_DATE = "Aufgabe auswählen, um das
                Fälligkeitsdatum zu bearbeiten" -%}

                {%- set ns.CHORE_DETAIL_LABEL = "Aufgabendetails" -%} 

                {%- set ns.CURRENT_STATUS_LABEL = "Aktueller Status" -%} 

                {%- set ns.GLOBAL_STATUS_LABEL = "Globaler Status" -%} 

                {%- set ns.SHARED_CHORE_LABEL = "Gemeinschaftsaufgabe" -%}  

                {%- set ns.VALUE_LABEL = "Wert" -%}  

                {%- set ns.DUE_DATE_LABEL = "Fälligkeitsdatum" -%}  

                {%- set ns.RECURRENCE_LABEL = "Wiederholung" -%}  

                {%- set ns.NO_CHORE_SELECTED_LABEL = "Keine Aufgabe ausgewählt oder
                Status nicht verfügbar" -%} 

                {%- set ns.PLUS_NEXT_DUE = "+Nächste Fälligkeit" -%}  

                {%- set ns.PLUS_1_DAY = "+1 Tag" -%}  

                {%- set ns.PLUS_1_WEEK = "+1 Woche" -%}  

                {%- set ns.CLEAR_DATE = "Datum löschen" -%}  

                {%- set ns.SELECT_NEW_DATE_AND_TIME = "Neues Datum & Uhrzeit auswählen"
                -%}  

                {%- set ns.TAP_TO_CHANGE_HOLD_TO_SET = "(Tippen zum Ändern / Halten, um
                festzulegen)" -%}

                {%- set ns.RESET_ALL = "Alle zurücksetzen" -%}

                {%- set ns.OVERDUE_CHORES = "Überfällige Aufgaben" -%}

                {%- set ns.RESET_OVERDUE_STATUS = "Überfälligen Status zurücksetzen" -%}

                {%- set ns.ALLOW_MULTIPLE_CLAIMS = "Mehrfachansprüche erlauben" -%}
        
                {%- set ns.APPLICABLE_DAYS = "Geltende Tage" -%}

                {#-- ************* End Translatable Text ************* --#} 

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Collect Points -- #}  

                {%- set points_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_points' -%}    {%- set ns.points = states(points_sensor) |
                int(default=0) -%}  {%- set ns.points_label =
                state_attr(points_sensor, 'unit_of_measurement') -%}  {%- set
                ns.points_icon = state_attr(points_sensor, 'icon') -%}

                {# -- Get Selected Chore from Input Select -- #} 

                {%- set ns.chore_select_entity = 'select.kc_' ~
                ns.Kid_name_normalize ~ '_chore_list' -%}  {%- set
                ns.chore_selected = states(ns.chore_select_entity) -%}  {%- set
                ns.chore_sensor_id_prefix ='sensor.kc_' ~ ns.Kid_name_normalize
                ~ '_chore_status_' -%}

                {# -- Collect Chore Status Sensor and Details -- #}          

                {%- if ns.chore_selected | lower not in ['none', 'unknown',
                'unavailable', ''] -%}

                  {# -- Replace Accented Letters -- #}

                  {%- set ns.chore_selected_normalize = ns.chore_selected -%}  
                  {%- for letter, replacement in replacements.items() -%}
                    {%- set ns.chore_selected_normalize = ns.chore_selected_normalize | replace(letter, replacement) -%}
                  {%- endfor -%}

                  {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                  {%- set ns.chore_selected_normalize = ns.chore_selected_normalize
                      | regex_replace("[^a-zA-Z0-9]", "_")
                      | regex_replace("_+", "_")
                      | regex_replace("^_", "")
                      | regex_replace("_$", "")
                      | lower
                  -%}
                  
                  {%- set ns.chore_sensor_id = ns.chore_sensor_id_prefix ~ ns.chore_selected_normalize -%}       
                  {%- set ns.current_status = states(ns.chore_sensor_id) | default('Unknown') -%}
                  {%- set ns.global_status = state_attr(ns.chore_sensor_id, 'global_state') | default('Unknown') -%}
                  {%- set ns.shared_chore = state_attr(ns.chore_sensor_id, 'shared_chore') | default('False') -%}
                  {%- set ns.recurrence = state_attr(ns.chore_sensor_id, 'recurring_frequency') | default('Not Recurring') -%}
                  {%- set ns.chore_value = state_attr(ns.chore_sensor_id, 'default_points') | int(default=0) -%}
                  {%- set ns.chore_icon = state_attr(ns.chore_sensor_id, 'icon') | default('mdi:clipboard-check') -%}
                  {%- set ns.chore_description = state_attr(ns.chore_sensor_id, 'description') | default('') -%}
                  {%- set ns.chore_days = state_attr(ns.chore_sensor_id, 'applicable_days') | default([], true)  -%}
                  {%- set ns.chore_allow_multiple = state_attr(ns.chore_sensor_id, 'allow_multiple_claims_per_day') | default('') -%}

                  {# -- Convert and Format Due Date -- #}
                  {%- set due_date = state_attr(ns.chore_sensor_id, 'due_date') -%}
                  {%- set due_date_local = as_datetime(due_date).astimezone() if due_date else None -%}
                  {%- set ns.due_date_formatted = due_date_local.strftime('%a, %b %d, %Y %I:%M %p') if due_date_local else 'None' -%}
                {%- endif -%}

                 {%- set ns.select_new_date_and_time_secondary = ns.TAP_TO_CHANGE_HOLD_TO_SET + "\n \n" + (as_datetime(states('input_datetime.kc_ui_set_date_helper'))).strftime('%a, %b %d, %Y %I:%M %p') if states('input_datetime.kc_ui_set_date_helper') != 'unknown' else 'No date set' -%}

                {#-- Store the Markdown content in a variable --#}

                {%- set ns.content =  "### <ha-icon icon='" ~ ns.chore_icon ~ "'></ha-icon> " ~ ns.CHORE_DETAIL_LABEL ~ ": " ~ (ns.chore_selected | title) ~ "  \n" -%}
                {%- set ns.content =  ns.content ~ "#### 📖 &nbsp;&nbsp;" ~ ns.chore_description ~ "  \n" if ns.chore_description else "" -%}
                {%- set ns.content = ns.content ~ 
                  "**📌 " ~ ns.CURRENT_STATUS_LABEL ~ ":** &nbsp;" ~ ns.current_status ~ "  \n"
                  "**🌍 " ~ ns.GLOBAL_STATUS_LABEL ~ ":** &nbsp;" ~ ns.global_status ~ "  \n"
                  "**👥 " ~ ns.SHARED_CHORE_LABEL ~ ":** &nbsp;" ~ ns.shared_chore ~ "  \n"
                  "**👥 " ~ ns.ALLOW_MULTIPLE_CLAIMS ~ ":** &nbsp;" ~ ns.chore_allow_multiple ~ "  \n"
                  "**💎 " ~ ns.VALUE_LABEL ~ ":** &nbsp;" ~ ns.chore_value ~ " " ~ ns.points_label ~ "  \n\n"
                  "**📅 " ~ ns.DUE_DATE_LABEL ~ ":** &nbsp;" ~ ns.due_date_formatted ~ "  \n"
                  "**🔁 " ~ ns.RECURRENCE_LABEL ~ ":** &nbsp;" ~ ns.recurrence ~ "  \n" -%}
                {%- set ns.content =  ns.content ~  "**🔵 " ~ ns.APPLICABLE_DAYS ~ ":** &nbsp;" ~ ns.chore_days | join(', ') | title if ns.chore_days | length > 0 else "" -%}
                {%- set ns.content =  ns.content
                  if ns.chore_selected not in ['None', 'unknown', 'unavailable'] 
                  else "**🚫 " ~ ns.NO_CHORE_SELECTED_LABEL ~ "**"
                -%}

                {# -- Construct Overdue chore reset, chore dropdown, Markdown
                Card for Chore Details, and chore actions -- #} {%- if
                states.sensor 
                    | selectattr('entity_id', 'match', '^' ~ ns.chore_sensor_id_prefix ~ '.*') 
                    | selectattr('state', 'eq', 'overdue') 
                    | list | length > 0 -%}
                  
                  {{
                    {
                      'type': 'grid',
                      'title': '',
                      'columns': 1,
                      'square': false,
                      'cards': [
                        {
                          'type': 'custom:mushroom-template-card',
                          'primary': ns.RESET_ALL ~ ' ' ~ ns.Kid_name ~ '\'s ' ~ ns.OVERDUE_CHORES,
                          'icon': 'mdi:restore-alert',
                          'icon_color': 'orange',
                          'tap_action': {
                            'action': 'call-service',
                            'service': 'kidschores.reset_overdue_chores',
                            'data': {
                              'kid_name': ns.Kid_name
                            }
                          }
                        }
                      ]
                    }
                  }},
                {%- endif -%}      
                  {{
                      {
                        'type': 'custom:mushroom-select-card',
                        'entity': ns.chore_select_entity,
                        'name': ns.SELECT_CHORE_TO_EDIT_DUE_DATE,
                        'icon': 'mdi:clipboard-edit',
                        'icon_color': 'blue',
                        'secondary_info': 'none'       
                      } 
                  }},
                  
                 {%- if ns.chore_selected | lower not in ['none', 'unknown', 'unavailable', ''] -%}  
                     {{
                      {
                        'type': 'markdown',
                        'content': ns.content
                      }
                    }},
                    {%- if states(ns.chore_sensor_id) | lower in ['overdue'] -%}
                        {{
                          {
                            'type': 'grid',
                            'title': '',
                            'columns': 1,
                            'square': false,
                            'cards': [
                              {
                                'type': 'custom:mushroom-template-card',
                                'primary': ns.RESET_OVERDUE_STATUS,
                                'icon': 'mdi:restore',
                                'icon_color': 'orange',
                                'tap_action': {
                                  'action': 'call-service',
                                  'service': 'kidschores.reset_overdue_chores',
                                  'data': {
                                    'chore_name': ns.chore_selected,
                                    'kid_name': ns.Kid_name
                                  }
                                }
                              }
                            ]
                          }
                        }},
                      {%- endif -%}
                      {{
                        {
                          'type': 'grid',
                          'title': '',
                          'columns': 4,
                          'square': False,
                          'cards': [
                            {
                              'type': 'custom:mushroom-template-card',
                              'primary': ns.PLUS_NEXT_DUE,
                              'icon': 'mdi:calendar-refresh',
                              'icon_color': 'blue',
                              'layout': 'vertical',
                              'tap_action': {
                                'action': 'call-service',
                                'service': 'kidschores.skip_chore_due_date',
                                'data': {
                                  'chore_name': ns.chore_selected
                                }
                              }
                            },
                            {
                              'type': 'custom:mushroom-template-card',
                              'primary': ns.PLUS_1_DAY,
                              'icon': 'mdi:calendar-plus',
                              'icon_color': 'blue',
                              'layout': 'vertical',
                              'tap_action': {
                                'action': 'call-service',
                                'service': 'kidschores.set_chore_due_date',
                                'data': {
                                  'chore_name': ns.chore_selected,
                                  'due_date': (as_datetime(due_date) + timedelta(days=1)).isoformat() if due_date else ''
                                }
                              }
                            },
                            {
                              'type': 'custom:mushroom-template-card',
                              'primary': ns.PLUS_1_WEEK,
                              'icon': 'mdi:calendar-arrow-right',
                              'icon_color': 'blue',
                              'layout': 'vertical',
                              'tap_action': {
                                'action': 'call-service',
                                'service': 'kidschores.set_chore_due_date',
                                'data': {
                                  'chore_name': ns.chore_selected,
                                  'due_date': (as_datetime(due_date) + timedelta(weeks=1)).isoformat() if due_date else ''
                                }
                              }
                            },
                            {
                              'type': 'custom:mushroom-template-card',
                              'primary': ns.CLEAR_DATE,
                              'icon': 'mdi:calendar-remove',
                              'icon_color': 'blue',
                              'layout': 'vertical',
                              'tap_action': {
                                'action': 'call-service',
                                'service': 'kidschores.set_chore_due_date',
                                'data': {
                                  'chore_name': ns.chore_selected,
                                  'due_date': ''
                                }
                              }
                            }
                          ]
                        }
                      }},{{
                      {
                        'type': 'grid',
                        'columns': 1,
                        'square': false,
                        'cards': [
                          {
                            'type': 'custom:mushroom-template-card',
                            'entity': 'input_datetime.kc_ui_set_date_helper',
                            'primary': ns.SELECT_NEW_DATE_AND_TIME,
                            'secondary': ns.select_new_date_and_time_secondary,
                            'multiline_secondary': 'true',
                            'fill_container': 'true',
                            'icon': 'mdi:calendar-edit',
                            'icon_color': 'blue',
                            'tap_action': {
                              'action': 'more-info'
                            },
                            'hold_action': {
                              'action': 'call-service',
                              'service': 'kidschores.set_chore_due_date',
                              'data': {
                                'chore_name': ns.chore_selected,
                                'due_date': states('input_datetime.kc_ui_set_date_helper')
                              }
                            }
                          },
                        ]
                      }
                    }}
                {%- endif -%}
      - type: grid
        square: false
        columns: 1
        grid_options:
          columns: full
        cards:
          - type: heading
            icon: mdi:plus-circle-multiple
            heading: Pluspunkte & Minuspunkte
            heading_style: title
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                prefix_pattern='', sorted_entities=[]) -%}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {{
                  {
                    'type': 'custom:mini-graph-card',
                    'hours_to_show': '168',
                    'unit': ' ',
                    'entities': [
                      {
                      'entity': 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points'
                      },
                    ]
                  }
                }},
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 6
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                prefix_pattern='', sorted_entities=[]) -%}

                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {#-- Build a list of button entities for this kid --#}    {%-
                set ns.prefix_pattern = 'button\\.kc_' ~ (ns.Kid_name_normalize)
                -%}  {%- set buttons = states.button 
                    | selectattr('entity_id', 'match', ns.prefix_pattern~ '(.*?)_points$') 
                    | list -%}

                {#-- Extract numeric values from entity names --#} {%- set
                numbers = buttons 
                    | map(attribute='entity_id') 
                    | map('regex_replace', '.*_(plus|minus)_(\\d+)_points$', '\\1\\2') 
                    | map('replace', 'plus', '') 
                    | map('replace', 'minus', '-') 
                    | map('int') 
                    | list -%}

                {% set sorted_numbers = numbers | sort %} {% for num in
                sorted_numbers %}
                  {% if num < 0 %}
                    {% set ns.sorted_entities = ns.sorted_entities + [ns.prefix_pattern | replace('\\', '')~'_minus_' ~ (num * -1) ~ '_points'  ] %}
                  {% else %}
                    {% set ns.sorted_entities = ns.sorted_entities + [ns.prefix_pattern | replace('\\', '')~'_plus_' ~ num ~ '_points'] %}
                  {% endif %}
                {% endfor %}

                {% for button_name in ns.sorted_entities -%}

                    {%- set primary = '+'~ button_name.split('_')[-2] if '_plus_' in button_name else '-'~ button_name.split('_')[-2] -%}          
                    {%- set icon = 'mdi:plus-circle' if '_plus_' in button_name else 'mdi:minus-circle' -%}
                    {%- set icon_color = 'green' if '_plus_' in button_name else 'red' -%}
                    {{
                      {
                        'type': 'custom:mushroom-template-card',
                        'entity': button_name,
                        'primary': primary,
                        'icon': icon,
                        'icon_color': icon_color,
                        'layout': 'vertical',
                        'tap_action': {
                          'action': 'toggle'
                        },
                        'hold_action': {
                          'action': 'more-info'
                        }
                      }
                    }},
                {%- endfor %}
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 2
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                current_points='', points_label='', PENALTY_LABEL='',
                APPLIED_LABEL='', APPLIED_TIMES='') -%}  

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.PENALTY_LABEL = 'Strafe' -%}  

                {%- set ns.APPLIED_LABEL = 'Angewendet' -%} 

                {%- set ns.APPLIED_TIMES = 'Mal' -%}  

                {#-- ************* End Translatable Text ************* --#}  



                {# -- Set Kid_name and normalize -- #}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {# -- Replace Accented Letters -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%} {%- for letter,
                replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {# -- Convert All Non-Alphanumeric Characters to "_" -- #}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {# -- Point Labels -- #}     {%- set points_sensor =
                'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%} {%- set
                ns.current_points = states(points_sensor) | int(default=0) -%}
                {%- set ns.points_label = state_attr(points_sensor,
                'unit_of_measurement') -%}  {%- set ns.points_icon =
                state_attr(points_sensor, 'icon') -%}

                {#-- Gather Button Entities --#}    {%- set prefix_pattern =
                'button\\.kc_' ~ (ns.Kid_name_normalize) ~ '_penalty_' -%} {%-
                set buttons = states.button | selectattr('entity_id', 'match',
                prefix_pattern) | list -%} 

                {%- for button in buttons -%}
                  {%- set sensor_id = button.entity_id 
                      | regex_replace('^button\\.kc_', 'sensor.kc_') 
                      | regex_replace('_penalty_', '_penalties_applied_') -%}
                  {%- set penalty_points = state_attr(sensor_id, 'penalty_points') | int(default=0) -%}
                  {%- set penalties_applied = states(sensor_id) | int(default=0) -%}

                  {%- set primary = ns.PENALTY_LABEL ~ ": " ~button.attributes.friendly_name | regex_replace("^.* - ", "") -%}

                  {%- set secondary = 
                    '💥 ' ~ ns.PENALTY_LABEL ~ ':  ' ~ (penalty_points | string) ~ ' ' ~ ns.points_label ~ '\n' ~
                    '📊 ' ~ ns.APPLIED_LABEL ~ ':  ' ~ (penalties_applied | string) ~ ' ' ~ ns.APPLIED_TIMES -%}

                  {%- set icon_color = 
                    'red' if penalty_points >= 20 else 
                    'orange' if penalty_points >= 10 else 
                    'blue' 
                  -%}

                  {{
                    {
                      'type': 'custom:mushroom-template-card',
                      'entity': button.entity_id,
                      'primary': primary,
                      'secondary': secondary,
                      'multiline_secondary': 'true',
                      'layout': 'vertical',
                      'icon': button.attributes.icon,
                      'icon_color': icon_color,
                      'tap_action': {
                        'action': 'toggle'
                      },
                      'hold_action': {
                        'action': 'more-info'
                      }
                    }
                  }},
                {%- endfor -%}
            sort:
              method: friendly_name
      - square: false
        type: grid
        cards:
          - type: heading
            icon: mdi:clipboard-text
            heading: 7-Tage-Aktivitätsprotokoll
            heading_style: title
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {%- set ns = namespace(Kid_name='', Kid_name_normalize='',
                entity_list=[]) -%}  

                {# -- Set Kid_name and normalize -- #}  {%- set ns.Kid_name =
                'Kidname'-%} {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z",
                    " ": "_"
                } -%} {%- set ns.Kid_name_normalize = ns.Kid_name -%}  {%- for
                letter, replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%} {%- set ns.Kid_name_normalize =
                ns.Kid_name_normalize | lower -%}

                {#-- Build a list of entities for this kid, excluding unwanted
                sensors --#} {%- set prefix_pattern = '(button|sensor)\\.kc_' ~
                (ns.Kid_name_normalize) ~ '_' -%} {%- set exclude_pattern =
                '^sensor\\.kc_' ~ (ns.Kid_name_normalize) ~
                '_(chore_(claims|approvals|streak)|reward_(claims|approvals))_'
                -%}

                {%- set entities = (states.button | selectattr('entity_id',
                'match', prefix_pattern) | list) +
                                   (states.sensor | selectattr('entity_id', 'match', prefix_pattern) 
                                    | rejectattr('entity_id', 'match', exclude_pattern) | list) -%}

                {%- for entity in entities -%}
                    {%- set ns.entity_list = ns.entity_list + [entity.entity_id] -%}
                {%- endfor -%} {{
                  {
                    'type': 'logbook',
                    'title': '',
                    'hours_to_show': 168,
                    'target': {
                      'entity_id': ns.entity_list
                    },
                  }
                }},
        columns: 1
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- Initialize Namespace Variables --#}  

                {%- set ns = namespace(
                  Kid_name='', Kid_name_normalize='', badge_sensor_id_prefix='', 
                  badges=[], points='', points_label='', points_sensor='', 
                  all_time_sensor='', threshold_type='', threshold_display='', 
                  points_multiplier='', kids_earned='', earned_text='', 

                  BADGE_TITLE='', STATUS='', THRESHOLD='', MULTIPLIER='', 
                  EARNED_BY='', NO_BADGES_FOUND='', BADGE_SETUP_PROMPT='', 
                  IN_PROGRESS='', EARNED='', REMAINING='', CHORES=''
                ) -%}    

                {#-- ************* Set Translatable Text ************* --#}  

                {%- set ns.BADGE_TITLE = "**Abzeichen:** " -%} 

                {%- set ns.STATUS = "🏅 Status:" -%} 

                {%- set ns.THRESHOLD = "🎯 Schwelle:" -%}

                {%- set ns.MULTIPLIER = "💎 Multiplikator:" -%} 

                {%- set ns.EARNED_BY = "👥 Erhalten von:" -%}

                {%- set ns.NO_BADGES_FOUND = "### 🏅 Keine Abzeichen gefunden  \n" -%}

                {%- set ns.BADGE_SETUP_PROMPT = "Richte Abzeichen ein, um Meilensteine zu belohnen
                und Aufgaben spaßig zu halten!" -%} 

                {%- set ns.IN_PROGRESS = "⌛ In Bearbeitung" -%} 

                {%- set ns.EARNED = "✔️ Erhalten" -%}

                {%- set ns.REMAINING = "noch zu tun!" -%}

                {%- set ns.CHORES = "Aufgaben" -%}

                {#-- ************* End Translatable Text ************* --#}

                {#-- Set Kid_name and normalize --#}  

                {%- set ns.Kid_name = 'Kidname' -%}

                {%- set replacements = {
                    "Á": "a", "á": "a", "Ą": "a", "ą": "a", "Ă": "a", "ă": "a", "Â": "a", "â": "a",
                    "Č": "c", "č": "c", "Ć": "c", "ć": "c",
                    "Ď": "d", "ď": "d",
                    "É": "e", "é": "e", "Ě": "e", "ě": "e", "Ę": "e", "ę": "e",
                    "Í": "i", "í": "i", "Î": "i", "î": "i",
                    "Ł": "l", "ł": "l",
                    "Ń": "n", "ń": "n", "Ň": "n", "ň": "n",
                    "Ó": "o", "ó": "o", "Ő": "o", "ő": "o", "Ö": "o", "ö": "o",
                    "Ř": "r", "ř": "r",
                    "Š": "s", "š": "s", "Ś": "s", "ś": "s", "Ș": "s", "ș": "s",
                    "Ț": "t", "ț": "t", "Ť": "t", "ť": "t",
                    "Ú": "u", "ú": "u", "Ű": "u", "ű": "u", "Ů": "u", "ů": "u", "Ü": "u", "ü": "u",
                    "Ý": "y", "ý": "y",
                    "Ž": "z", "ž": "z", "Ź": "z", "ź": "z", "Ż": "z", "ż": "z"
                } -%}

                {%- set ns.Kid_name_normalize = ns.Kid_name -%}   {%- for
                letter, replacement in replacements.items() -%}
                  {%- set ns.Kid_name_normalize = ns.Kid_name_normalize | replace(letter, replacement) -%}
                {%- endfor -%}

                {%- set ns.Kid_name_normalize = ns.Kid_name_normalize
                    | regex_replace("[^a-zA-Z0-9]", "_")
                    | regex_replace("_+", "_")
                    | regex_replace("^_", "")
                    | regex_replace("_$", "")
                    | lower
                -%}

                {#-- Collect Points --#}  

                {%- set points_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~
                '_points' -%}    {%- set ns.points = states(points_sensor) |
                int(default=0) -%}  {%- set ns.points_label =
                state_attr(points_sensor, 'unit_of_measurement') -%}  {%- set
                ns.points_icon = state_attr(points_sensor, 'icon') -%}

                {#-- Collect Total Completed --#}  

                {%- set ns.all_time_sensor = 'sensor.kc_' ~
                ns.Kid_name_normalize ~ '_chores_completed_total' -%} 

                {#-- Badge Sensors --#}  

                {%- set badge_sensors = states.sensor 
                    | selectattr('entity_id', 'match', '^sensor\\.kc_.*_badge$') 
                    | rejectattr('entity_id', 'search', '_highest_badge$') 
                    | list 
                -%}

                {#-- Collect badge attributes --#}  

                {%- for badge_sensor in badge_sensors -%}
                    {%- set badge_info = {
                        'entity_id': badge_sensor.entity_id,
                        'name': (state_attr(badge_sensor.entity_id, 'friendly_name') | default('UNKNOWN BADGE')) | regex_replace('^Badge - ', ''),
                        'icon': state_attr(badge_sensor.entity_id, 'icon') | default('mdi:medal-outline'),
                        'description': state_attr(badge_sensor.entity_id, 'description') | default(''),
                        'threshold': states(badge_sensor.entity_id) | float(default=0),
                        'threshold_display': (states(badge_sensor.entity_id) | float(default=0) | round(0)) ~ " " ~ 
                                             (ns.points_label if state_attr(badge_sensor.entity_id, 'threshold_type') == "points" else ns.CHORES),
                        'points_multiplier': state_attr(badge_sensor.entity_id, 'points_multiplier') | float(default=1),
                        'kids_earned': state_attr(badge_sensor.entity_id, 'kids_earned') | default([], true),
                        'earned_text': ns.EARNED if ns.Kid_name in (state_attr(badge_sensor.entity_id, 'kids_earned') | default([], true)) else ns.IN_PROGRESS
                    } -%}     
                    {%- set ns.badges = ns.badges + [badge_info] -%}
                {%- endfor -%}

                {%- set sorted_badges = ns.badges | sort(reverse=true,
                attribute='threshold') | sort(reverse=true,
                attribute='points_multiplier') -%}

                {%- if sorted_badges | length == 0 -%}
                  {{
                    {
                      'type': 'markdown',
                      'content': ns.NO_BADGES_FOUND ~ " \n" ~ ns.BADGE_SETUP_PROMPT
                    }
                  }},  
                {%- else -%}
                  {%- for badge in sorted_badges -%}
                    {%- set required_value = badge.threshold -%}
                    {%- set progress_value = ns.points if ns.points_label in badge.threshold_display else states(ns.all_time_sensor) | int(default=0) -%}
                    {%- set earned = ns.Kid_name in badge.kids_earned -%}
                    {%- set remaining_value = (required_value - progress_value) | round(0) if required_value > progress_value and not earned else 0 -%}
                    {%- set remaining_text = " (" ~ remaining_value|string ~ " " ~ ns.REMAINING ~ ")" if remaining_value > 0 else "" -%}

                    {%- set content = "## <ha-icon icon=" ~ badge.icon ~ "></ha-icon> " ~ ns.BADGE_TITLE ~ badge.name ~ "  \n" %}
                    {%- if badge.description -%}
                      {%- set content = content ~ "#### 📖 &nbsp;" ~ badge.description ~ "  \n" %}
                    {%- endif -%}
                    {%- set content = content ~ "**" ~ ns.STATUS ~ "** &nbsp;" ~ badge.earned_text ~ "  \n" %}
                    {%- set content = content ~ "**" ~ ns.THRESHOLD ~ "** &nbsp;" ~ badge.threshold_display ~ remaining_text ~ "  \n" %}
                    {%- if badge.points_multiplier > 1 -%}
                      {%- set content = content ~ "**" ~ ns.MULTIPLIER ~ "** &nbsp;x" ~ badge.points_multiplier|string ~ "  \n" %}
                    {%- endif -%}
                    {%- if badge.kids_earned | count > 0 -%}
                      {%- set content = content ~ "**" ~ ns.EARNED_BY ~ "** &nbsp;" ~ badge.kids_earned | join(', ') ~ "  \n" %}
                    {%- endif -%}


                    {{
                      {
                        'type': 'markdown',
                        'content': content
                      }
                    }},  
                  {%- endfor -%}
                {%- endif -%}
cards: []
